import pandas as pd
import requests
from io import StringIO

def get_all_ecb_exchange_rates(base_currency='EUR', start=None, end=None, frequency='D'):
    """
    Download ALL available currencies from the ECB with FULL metadata.
    
    Parameters:
    ----------
    base_currency : str (default 'EUR')
        Reference currency (e.g., 'EUR', 'USD')
    start : str (optional)
        Start date 'YYYY-MM-DD'
    end : str (optional)
        End date 'YYYY-MM-DD'
    frequency : str (default 'D')
        'D' = daily, 'M' = monthly
    
    Returns:
    --------
    DataFrame containing all historical series and complete metadata
    """
    base_url = "https://data-api.ecb.europa.eu/service/data/EXR"
    series_id = f"{frequency}..{base_currency}.SP00.A"  # All currencies
    
    # Build the query
    params = {
        'format': 'csvdata',
        'startPeriod': start,
        'endPeriod': end
    }
    # Remove None parameters
    params = {k: v for k, v in params.items() if v is not None}
    
    try:
        # Send the request
        response = requests.get(f"{base_url}/{series_id}", params=params)
        response.raise_for_status()
        
        # Read CSV content
        df = pd.read_csv(StringIO(response.text), comment='#')
        df.columns = [c.strip() for c in df.columns]
        
        # Standardize column names
        col_mapping = {
            'TIME_PERIOD': 'date',
            'CURRENCY': 'target_currency',
            'OBS_VALUE': 'exchange_rate',
            'FREQ': 'frequency',
            'CURRENCY_DENOM': 'base_currency',
            'EXR_TYPE': 'rate_type',
            'EXR_SUFFIX': 'suffix',
            'OBS_STATUS': 'status',
            'OBS_CONF': 'confidence',
            'OBS_PRE_BREAK': 'pre_break',
            'OBS_COM': 'comments'
        }
        
        # Rename columns if present
        df = df.rename(columns={k: v for k, v in col_mapping.items() if k in df.columns})
        
        # Type conversions
        if 'date' in df.columns:
            df['date'] = pd.to_datetime(df['date'])
        if 'exchange_rate' in df.columns:
            df['exchange_rate'] = pd.to_numeric(df['exchange_rate'], errors='coerce')
        
        # Add download timestamp
        df['download_timestamp'] = pd.Timestamp.now()
        
        return df.sort_values(['target_currency', 'date']).reset_index(drop=True)
    
    except Exception as e:
        print(f"Error during download: {str(e)}")
        return pd.DataFrame()

# Full usage example
if __name__ == "__main__":
    # Download all available data (can take time)
    all_rates = get_all_ecb_exchange_rates(
        base_currency='EUR',
        start='2000-01-01',  # Optional: remove to get full history
        frequency='D'         # 'M' for monthly data
    )
    
    if not all_rates.empty:
        print(f"Downloaded {len(all_rates)} records")
        print("Available currencies:", all_rates['target_currency'].unique())
        print("\nData sample:")
        print(all_rates.head(10))
    else:
        print("No data downloaded")
